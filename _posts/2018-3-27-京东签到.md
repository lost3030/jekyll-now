---
layout: post
title: 京东签到
---

大致思路是在ubuntu下启动python脚本调用selenium框架模拟浏览器进行签到

### 环境部署

1.ubuntu从小到大用得最多，安装各种包也方便，没有的最好弄个虚拟机。  
2.ubuntu安装好后执行下面命令  
```
sudo apt-get update
sudo apt-get upgrade
apt-get install python-pip
sudo apt-get install xvfb
sudo Xvfb :10 -ac
sudo pip install selenium
sudo apt-get install python-dev
sudo apt-get install libevent-dev
sudo apt-get install libssl-dev
sudo pip install scrapy
sudo pip install requests
sudo pip install pyvirtualdisplay
wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add - 
sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
sudo apt-get update 
sudo apt-get install google-chrome-stable
sudo pip install xlrd
```
3.chromedirver下载（网上随便搜）: https://npm.taobao.org/mirrors/chromedriver  
```
sudo mv chromedriver /usr/local/bin/chromedriver
sudo chmod u+x,o+x /usr/local/bin/chromedriver
```

### 开始操作

```
#-*-coding:utf8-*-
import requests
import ConfigParser
import urllib2
import string, os, sys
import chaojiying
import time
from pyvirtualdisplay import Display
from selenium import webdriver
reload(sys)
sys.setdefaultencoding('utf8')
from scrapy import Selector
from contextlib import closing

def login():
    #自己填入帐号密码（当前实现邮箱签到，手机号有验证比较烦）
    username='XXXX@163.com'
    password='XXXX'

    display = Display(visible=0, size=(800, 600))
    display.start()

    browser = webdriver.Chrome('/usr/local/bin/chromedriver')
    #能wap页操作就wap页操作
    url='https://m.kaola.com/login.html'
    browser.get(url)
    time.sleep(7)

    #切换到邮箱登录
    browser.find_element_by_id("loginemail").click();
    time.sleep(7)
    print "切换到邮箱登录 done"
    
    #由于内部有多个iframe，所以就要进入iframe
    for frame in browser.find_elements_by_xpath("//*[contains(@id,'x-URS-iframe')]"):
        try:
            browser.switch_to.frame(frame)
            time.sleep(7)

            print "进入iframe"

            #输入帐号密码
            browser.find_element_by_xpath("//*[contains(@class,'j-inputtext dlemail')]").clear();
            browser.find_element_by_xpath("//*[contains(@class,'j-inputtext dlemail')]").send_keys(username)   

            browser.find_element_by_xpath("//*[contains(@class,'j-inputtext dlpwd')]").clear();
            browser.find_element_by_xpath("//*[contains(@class,'j-inputtext dlpwd')]").send_keys(password);
            #可以看看是否真的写成功了
            print browser.find_element_by_xpath("//*[contains(@class,'j-inputtext dlemail')]").get_attribute("value")

            #检查下当前url
            print browser.current_url
            #点击登录
            browser.find_element_by_id('dologin').click();

            time.sleep(10)
            #检查下当前url
            print browser.current_url

            #进入签到页
            url='https://www.kaola.com/personal/my_point/index.html?'
            browser.get(url)
            time.sleep(10)
            
            #click会失焦，或者xpath问题，这边换个姿势点击签到按钮
            #browser.find_element_by_xpath("//*[contains(@class,'u-btn  u-btn-checkin')]").click();
            print browser.find_element_by_xpath("//*[contains(@class,'u-btn  u-btn-checkin')]").get_attribute('class')
            browser.find_element_by_xpath("//*[contains(@class,'u-btn  u-btn-checkin')]").send_keys("\n")
            time.sleep(10)
            
            #测试的时候可以通过输出网页源码查看需要的元素是否已经加载
            #print browser.page_source
            #return

            break
         
        except Exception, e:
            browser.switch_to.default_content()
            print "error frame"
            print e

    #关闭浏览器
    browser.quit()

    display.stop()

if __name__=='__main__':
    login()
    
#-*-coding:utf8-*-
import requests
import ConfigParser
import urllib2
import string, os, sys
import chaojiying
import time
from pyvirtualdisplay import Display
from selenium import webdriver
reload(sys)
sys.setdefaultencoding('utf8')
from scrapy import Selector
from contextlib import closing

def login():
    print "start"
    #自己填入帐号密码
    username='aaa'
    password='mima'

    display = Display(visible=0, size=(3800, 3600))
    display.start()

    browser = webdriver.Chrome('/usr/local/bin/chromedriver')
    url='https://passport.jd.com/uc/login'
    browser.get(url)
    time.sleep(7)
    
    #测试的时候可以通过输出网页源码查看需要的元素是否已经加载
    #print browser.find_element_by_id("LoginForm_username").text
    #print browser.page_source
    #return
    
    #切换到账户登录
    browser.find_element_by_xpath("//*[contains(@clstag,'pageclick|keycount|201607144|2')]").send_keys("\n")
    time.sleep(7)
    
    browser.find_element_by_id("loginname").clear()
    browser.find_element_by_id("loginname").send_keys(username)   
    browser.find_element_by_id("nloginpwd").clear()
    browser.find_element_by_id("nloginpwd").send_keys(password)
    
    browser.find_element_by_id('loginsubmit').click()
    time.sleep(10)

    #jd比较简单，进去签到链接就签到了：）
    url='https://vip.jd.com/sign/index'
    browser.get(url)
    time.sleep(10)

    #关闭浏览器
    browser.quit()

    display.stop()

if __name__=='__main__':
    login()

```



